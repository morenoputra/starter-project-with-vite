var O=a=>{throw TypeError(a)};var _=(a,r,e)=>r.has(a)||O("Cannot "+e);var f=(a,r,e)=>(_(a,r,"read from private field"),e?e.call(a):r.get(a)),k=(a,r,e)=>r.has(a)?O("Cannot add the same private member more than once"):r instanceof WeakSet?r.add(a):r.set(a,e),C=(a,r,e,o)=>(_(a,r,"write to private field"),o?o.call(a,e):r.set(a,e),e),$=(a,r,e)=>(_(a,r,"access private method"),e);(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const l of t)if(l.type==="childList")for(const s of l.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function e(t){const l={};return t.integrity&&(l.integrity=t.integrity),t.referrerPolicy&&(l.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?l.credentials="include":t.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function o(t){if(t.ep)return;t.ep=!0;const l=e(t);fetch(t.href,l)}})();const j={BASE_URL:"https://story-api.dicoding.dev/v1",VAPID_PUBLIC_KEY:"BOSnAf_MsqMRlkQsXPliiAXLd7JtH13-YbDA-2n9ZTacYtkQ01HtTAjFl7r_9BSBhVn3UB47cSdlkrCbHiaZtAM"},P=j.BASE_URL.replace(/\/$/,"");async function H({token:a=null,page:r=1,size:e=20,location:o=1}={}){const t=`${P}/stories?page=${r}&size=${e}&location=${o}`,l={};return a&&(l.Authorization=`Bearer ${a}`),await(await fetch(t,{headers:l})).json()}async function F({token:a=null,description:r="",file:e=null,lat:o=null,lon:t=null}={}){const l=!!a,s=l?`${P}/stories`:`${P}/stories/guest`,i=new FormData;i.append("description",r),e&&i.append("photo",e,e.name||"photo.jpg"),o!=null&&i.append("lat",String(o)),t!=null&&i.append("lon",String(t));const c={};return l&&(c.Authorization=`Bearer ${a}`),await(await fetch(s,{method:"POST",headers:c,body:i})).json()}async function W({name:a,email:r,password:e}={}){const o=`${P}/register`;return await(await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:a,email:r,password:e})})).json()}async function V({email:a,password:r}={}){const e=`${P}/login`;return await(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:a,password:r})})).json()}async function z(){return j.VAPID_PUBLIC_KEY}async function Y({token:a=null,subscription:r}={}){return{error:!0,message:"SUBSCRIBE_ENDPOINT not configured. Register subscriptions server-side."}}const K="storymap-db",J=1,x="savedStories",M="outbox";function N(){return new Promise((a,r)=>{const e=indexedDB.open(K,J);e.onupgradeneeded=o=>{const t=o.target.result;t.objectStoreNames.contains(x)||t.createObjectStore(x,{keyPath:"id"}),t.objectStoreNames.contains(M)||t.createObjectStore(M,{autoIncrement:!0})},e.onsuccess=()=>a(e.result),e.onerror=()=>r(e.error)})}async function X(a){const r=await N();return new Promise((e,o)=>{const t=r.transaction(x,"readwrite");t.objectStore(x).put(a),t.oncomplete=()=>e(!0),t.onerror=()=>o(t.error)})}async function Z(){const a=await N();return new Promise((r,e)=>{const l=a.transaction(x,"readonly").objectStore(x).getAll();l.onsuccess=()=>r(l.result||[]),l.onerror=()=>e(l.error)})}async function Q(a){const r=await N();return new Promise((e,o)=>{const t=r.transaction(x,"readwrite");t.objectStore(x).delete(a),t.oncomplete=()=>e(!0),t.onerror=()=>o(t.error)})}class R{constructor(){this._map=null,this._markers=[]}async render(){return`
      <section class="container">
        <h1>Map Page</h1>
        <div class="map-list">
          <div id="map" class="map"></div>
          <div id="story-list" class="list"></div>
        </div>
      </section>
    `}async afterRender(){const r=localStorage.getItem("authToken")||null;if(!r){const n=document.getElementById("story-list");n.innerHTML='<p>You need to <a href="#/login">login</a> to view stories on the map.</p>';return}let e;try{const n=await H({token:r,page:1,size:50,location:1});n&&n.error===!1&&Array.isArray(n.listStory)?e=n.listStory:(e=[],console.warn("Failed to fetch stories or no stories with location available",n))}catch(n){console.error("Error fetching stories",n),e=[]}if(typeof L>"u"){const n=document.getElementById("story-list");n.innerHTML="<p>Leaflet library not loaded. Check internet connection.</p>";return}const o=()=>document.getElementById("map");let t=o();const l=8;let s=0;for(;!t&&s<l;)await new Promise(n=>setTimeout(n,50)),t=o(),s+=1;if(!t){const n=document.getElementById("story-list")||document.getElementById("main-content")||document.body;n.innerHTML="<p>Map container not found in the document. Please refresh the page.</p>",console.error("Map container (#map) not found after retries. Aborting map initialization.");return}this._map=L.map(t).setView([0,0],2);const i=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}),c=L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{attribution:"&copy; CartoDB"});i.addTo(this._map);const u={OpenStreetMap:i,"Carto Light":c};L.control.layers(u).addTo(this._map);const p=document.getElementById("story-list");if(p.innerHTML="",!e.length){p.innerHTML="<p>No story with location available or failed to fetch. If the API requires authentication, please provide a token in the app (localStorage key: authToken) or login first.</p>";return}const m=[];e.forEach((n,d)=>{const h=Number(n.lat),g=Number(n.lon);if(Number.isFinite(h)&&Number.isFinite(g)){const y=L.marker([h,g]).addTo(this._map),I=`
          <div style="min-width:150px">
            <img src="${n.photoUrl}" alt="${n.name}" style="width:100%;height:auto;margin-bottom:8px;" />
            <strong>${n.name}</strong>
            <p style="font-size:0.9rem">${new Date(n.createdAt).toLocaleString()}</p>
            <p>${n.description}</p>
          </div>
        `;y.bindPopup(I),this._markers.push(y),m.push([h,g]);const w=document.createElement("button");w.className="story-item",w.type="button",w.style.display="block",w.style.textAlign="left",w.style.width="100%",w.style.padding="8px",w.style.border="0",w.style.borderBottom="1px solid #eee",w.style.cursor="pointer",w.setAttribute("aria-label",`Open story ${n.name}`),w.innerHTML=`
          <div style="display:flex;gap:8px;align-items:center">
            <img src="${n.photoUrl}" alt="${n.name}" style="width:64px;height:64px;object-fit:cover;border-radius:6px;" />
            <div>
              <div style="font-weight:bold">${n.name}</div>
              <div style="font-size:0.85rem;color:#666">${new Date(n.createdAt).toLocaleDateString()}</div>
              <div style="font-size:0.9rem;margin-top:4px">${n.description}</div>
            </div>
          </div>
        `;const D=()=>{this._markers.forEach(E=>E.closePopup()),y.openPopup(),y.setZIndexOffset(1e3),this._map.setView([h,g],12)};w.addEventListener("click",()=>{D(),w.style.background="#f0f8ff",setTimeout(()=>w.style.background="",1e3)});const S=document.createElement("button");S.type="button",S.textContent="Save Offline",S.style.marginTop="8px",S.style.padding="8px 10px",S.style.borderRadius="6px",S.style.border="1px solid #e5e7eb",S.style.background="#fff",S.onclick=async()=>{try{const E={id:n.id||`${Date.now()}-${d}`,name:n.name,description:n.description,photoUrl:n.photoUrl,lat:n.lat,lon:n.lon,createdAt:n.createdAt};await X(E),window.showToast&&window.showToast("Story saved for offline")}catch(E){console.error("save offline error",E),window.showToast&&window.showToast("Failed to save story")}};const A=document.createElement("div");A.style.marginTop="8px",A.appendChild(S),w.appendChild(A),w.addEventListener("keydown",E=>{(E.key==="Enter"||E.key===" ")&&(E.preventDefault(),D(),w.focus())}),p.appendChild(w)}}),m.length>0&&this._map.fitBounds(m,{padding:[40,40]})}}class G{constructor(){this._map=null,this._selectedLat=null,this._selectedLon=null,this._cameraStream=null}async render(){return`
      <section class="container">
        <h1>Add Story</h1>

        <form id="add-story-form">
          <div>
            <label for="description">Description</label><br />
            <textarea id="description" name="description" rows="4" style="width:100%"></textarea>
          </div>

          <div style="margin-top:8px">
            <label for="photo">Photo (max 1MB)</label><br />
            <input id="photo" name="photo" type="file" accept="image/*" aria-label="Photo upload" />
            <button type="button" id="camera-button" aria-pressed="false">Use Camera</button>
            <div id="camera-preview" style="margin-top:8px"></div>
          </div>

          <div style="margin-top:8px">
            <div id="map-label" style="font-weight:600">Pick location by clicking on the map</div>
            <div id="map-add" style="height:40vh;margin-top:8px" role="application" aria-labelledby="map-label"></div>
            <div id="coords" style="margin-top:8px;color:#333" aria-live="polite">Lat: - , Lon: -</div>
          </div>

          <div style="margin-top:12px">
            <button type="submit">Submit</button>
          </div>

          <div id="form-message" style="margin-top:8px;color:green" role="status" aria-live="polite"></div>
        </form>
      </section>
    `}async afterRender(){const r=document.getElementById("add-story-form"),e=document.getElementById("photo"),o=document.getElementById("camera-button"),t=document.getElementById("camera-preview"),l=document.getElementById("coords"),s=document.getElementById("form-message");if(!(localStorage.getItem("authToken")||null)){s.style.color="red",s.innerHTML='You need to <a href="#/login">login</a> to add a story.';return}if(typeof L>"u"){s.style.color="red",s.textContent="Leaflet library not loaded.";return}this._map=L.map("map-add").setView([0,0],2),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(this._map);let c=null;this._map.on("click",u=>{const{lat:p,lng:m}=u.latlng;this._selectedLat=p,this._selectedLon=m,l.textContent=`Lat: ${p.toFixed(6)}, Lon: ${m.toFixed(6)}`,c?c.setLatLng([p,m]):c=L.marker([p,m]).addTo(this._map)}),o.addEventListener("click",async()=>{if(this._cameraStream){this._cameraStream.getTracks().forEach(u=>u.stop()),this._cameraStream=null,t.innerHTML="",o.textContent="Use Camera",o.setAttribute("aria-pressed","true");return}try{const u=await navigator.mediaDevices.getUserMedia({video:!0});this._cameraStream=u;const p=document.createElement("video");p.autoplay=!0,p.playsInline=!0,p.srcObject=u,p.style.maxWidth="100%",p.setAttribute("aria-label","Camera preview — click to capture"),t.innerHTML="",t.appendChild(p),o.textContent="Stop Camera (capture will use file input)",o.setAttribute("aria-pressed","true"),p.addEventListener("click",async()=>{const m=document.createElement("canvas");m.width=p.videoWidth,m.height=p.videoHeight,m.getContext("2d").drawImage(p,0,0);const d=await new Promise(y=>m.toBlob(y,"image/jpeg",.9)),h=new DataTransfer,g=new File([d],"capture.jpg",{type:"image/jpeg"});h.items.add(g),e.files=h.files,s.style.color="green",s.textContent="Captured image from camera and set as photo input.",s.setAttribute("role","status"),window.showToast&&window.showToast("Captured image from camera")})}catch(u){s.style.color="red",s.textContent="Failed to access camera: "+u.message,s.setAttribute("role","alert"),window.showToast&&window.showToast(s.textContent)}}),r.addEventListener("submit",async u=>{u.preventDefault(),s.style.color="green",s.textContent="";const p=document.getElementById("description").value.trim(),m=e.files&&e.files[0]?e.files[0]:null;if(!p){s.style.color="red",s.textContent="Description is required.";return}if(!m){s.style.color="red",s.textContent="Photo is required.";return}if(!this._selectedLat||!this._selectedLon){s.style.color="red",s.textContent="Please pick a location on the map.";return}if(m.size>1e6){s.style.color="red",s.textContent="Photo must be less than 1MB.";return}const n=localStorage.getItem("authToken")||null;try{const d=await F({token:n,description:p,file:m,lat:this._selectedLat,lon:this._selectedLon});d&&d.error===!1?(s.style.color="green",s.textContent="Story uploaded successfully.",window.showToast&&window.showToast("Story uploaded successfully"),r.reset(),this._cameraStream&&(this._cameraStream.getTracks().forEach(h=>h.stop()),this._cameraStream=null,t.innerHTML="")):(s.style.color="red",s.textContent=d&&d.message||"Failed to upload story.",window.showToast&&window.showToast(s.textContent))}catch(d){s.style.color="red",s.textContent="Error uploading story: "+d.message,window.showToast&&window.showToast(s.textContent)}})}}class ee{async render(){return`
    <section class="auth-container">
      <div class="auth-card">
        <h1 class="auth-title">Welcome back</h1>
        <p class="auth-sub">Login to continue to the app</p>
        <form id="login-form">
          <div class="form-row">
            <label for="email">Email</label>
            <input id="email" name="email" type="email" required />
          </div>
          <div class="form-row">
            <label for="password">Password</label>
            <input id="password" name="password" type="password" required />
          </div>
          <div class="form-row">
            <button type="submit" class="auth-button">Login</button>
          </div>
          <div id="login-message" role="status" aria-live="polite" class="form-message"></div>
        </form>
      </div>
    </section>
    `}async afterRender(r){const e=r.querySelector("#login-form"),o=r.querySelector("#login-message");if(!e||!o){console.error("Login form elements not found on the page!");return}e.addEventListener("submit",async t=>{t.preventDefault(),o.textContent="";const l=e.elements.email.value.trim(),s=e.elements.password.value;try{const i=await V({email:l,password:s});i&&i.error===!1&&i.loginResult&&i.loginResult.token?(localStorage.setItem("authToken",i.loginResult.token),i.loginResult.name&&localStorage.setItem("authName",i.loginResult.name),i.loginResult.userId&&localStorage.setItem("authUserId",i.loginResult.userId),o.style.color="green",o.textContent="Login successful. Token saved.",window.showToast&&window.showToast("Login successful"),window.dispatchEvent(new Event("authchange")),location.hash="#/"):(o.style.color="red",o.textContent=i&&i.message||"Login failed",window.showToast&&window.showToast(o.textContent))}catch(i){o.style.color="red",o.textContent="Login error: "+i.message}})}}class te{async render(){return`
    <section class="auth-container">
      <div class="auth-card">
        <h1 class="auth-title">Create account</h1>
        <p class="auth-sub">Register a new account to post stories</p>
        <form id="register-form">
          <div class="form-row">
            <label for="name">Full name</label>
            <input id="name" name="name" type="text" required />
          </div>
          <div class="form-row">
            <label for="email">Email</label>
            <input id="email" name="email" type="email" required />
          </div>
          <div class="form-row">
            <label for="password">Password</label>
            <input id="password" name="password" type="password" required minlength="8" />
          </div>
          <div class="form-row">
            <button type="submit" class="auth-button">Register</button>
          </div>
          <div id="register-message" role="status" aria-live="polite" class="form-message"></div>
        </form>
      </div>
    </section>
    `}async afterRender(r){const e=r.querySelector("#register-form"),o=r.querySelector("#register-message");if(!e||!o){console.error("Register form elements not found on the page!");return}e.addEventListener("submit",async t=>{t.preventDefault(),o.textContent="";const l=e.elements.name.value.trim(),s=e.elements.email.value.trim(),i=e.elements.password.value;try{const c=await W({name:l,email:s,password:i});c&&c.error===!1?(o.style.color="green",o.textContent="Registration successful. You can now login.",window.showToast&&window.showToast("Registration successful")):(o.style.color="red",o.textContent=c&&c.message||"Registration failed",window.showToast&&window.showToast(o.textContent))}catch(c){o.style.color="red",o.textContent="Registration error: "+c.message}})}}class oe{async render(){return`
      <section class="container">
        <h1>Profile</h1>
        <div id="profile-info"></div>
      </section>
    `}async afterRender(){const r=document.getElementById("profile-info"),e=localStorage.getItem("authName"),o=localStorage.getItem("authUserId");if(!localStorage.getItem("authToken")){r.innerHTML='<p>You are not logged in. <a href="#/login">Login</a></p>';return}r.innerHTML=`
      <p><strong>Name:</strong> ${e||"-"} </p>
      <p><strong>User ID:</strong> ${o||"-"} </p>
      <div style="margin-top:12px">
        <button id="logout-button">Logout</button>
      </div>
    `,document.getElementById("logout-button").addEventListener("click",()=>{localStorage.removeItem("authToken"),localStorage.removeItem("authName"),localStorage.removeItem("authUserId"),window.dispatchEvent(new Event("authchange")),window.showToast&&window.showToast("Logged out"),window.location.hash="#/login"})}}class ne{async render(){return`
      <section class="container">
        <h1>Saved Stories (Offline)</h1>
        <div id="saved-list" class="list"></div>
      </section>
    `}async afterRender(){const r=document.getElementById("saved-list");r.innerHTML="<p>Loading saved stories…</p>";try{const e=await Z();if(!e.length){r.innerHTML="<p>No saved stories yet.</p>";return}r.innerHTML="",e.forEach(o=>{const t=document.createElement("div");t.className="saved-item",t.style.padding="8px",t.style.borderBottom="1px solid #eee",t.innerHTML=`
          <div style="display:flex;gap:8px;align-items:center">
            <img src="${o.photoUrl}" alt="${o.name}" style="width:64px;height:64px;object-fit:cover;border-radius:6px;" />
            <div>
              <div style="font-weight:bold">${o.name}</div>
              <div style="font-size:0.85rem;color:#666">${new Date(o.createdAt).toLocaleString()}</div>
              <div style="margin-top:6px">${o.description}</div>
            </div>
          </div>
        `;const l=document.createElement("div");l.style.marginTop="8px";const s=document.createElement("button");s.textContent="Delete",s.onclick=async()=>{await Q(o.id),window.showToast&&window.showToast("Deleted saved story"),t.remove()},l.appendChild(s),t.appendChild(l),r.appendChild(t)})}catch(e){console.error("load saved error",e),r.innerHTML="<p>Failed to load saved stories.</p>"}}}const re={"/":new R,"/map":new R,"/add":new G,"/saved":new ne,"/login":new ee,"/register":new te,"/profile":new oe};function se(a){const r=a.split("/");return{resource:r[1]||null,id:r[2]||null}}function ae(a){let r="";return a.resource&&(r=r.concat(`/${a.resource}`)),a.id&&(r=r.concat("/:id")),r||"/"}function ie(){return location.hash.replace("#","")||"/"}function le(){const a=ie(),r=se(a);return ae(r)}var T,v,b,B,q;class ce{constructor({navigationDrawer:r,drawerButton:e,content:o}){k(this,B);k(this,T,null);k(this,v,null);k(this,b,null);C(this,T,o),C(this,v,e),C(this,b,r),$(this,B,q).call(this)}async renderPage(){if(!f(this,T))return;const r=document.querySelector("video");r&&r.srcObject&&(r.srcObject.getTracks().forEach(c=>c.stop()),r.srcObject=null);const e=le(),o=re[e],t=document.createElement("div");if(t.className="page",t.innerHTML=await o.render(),!!!t.querySelector("h1")){const c=window.location.hash.replace("#","")||"/",u={"/":"Map","/map":"Map","/add":"Add Story","/saved":"Saved Stories","/login":"Login","/register":"Register","/profile":"Profile"},p=document.createElement("h1");p.textContent=u[c]||"Page";const m=t.querySelector("section")||t;m.insertBefore(p,m.firstChild)}const s=f(this,T).querySelector(".page"),i=(c=!1)=>c?(t.classList.add("page-enter"),f(this,T).appendChild(t),t.getBoundingClientRect(),t.classList.add("page-enter-active"),s&&(s.classList.add("page-exit"),setTimeout(()=>{s.parentElement&&s.remove()},350)),350):(s&&s.remove(),f(this,T).appendChild(t),0);try{if(typeof document.startViewTransition=="function")await document.startViewTransition(()=>{i(!1)});else{const c=i(!0);await new Promise(u=>setTimeout(u,c))}}catch{const u=i(!0);await new Promise(p=>setTimeout(p,u))}await o.afterRender(t)}}T=new WeakMap,v=new WeakMap,b=new WeakMap,B=new WeakSet,q=function(){if(f(this,v)&&f(this,b)){f(this,v).setAttribute("aria-controls",f(this,b).id||"navigation-drawer"),f(this,v).setAttribute("aria-expanded","false");const r=()=>{const e=f(this,b).classList.toggle("open");f(this,v).setAttribute("aria-expanded",String(e))};f(this,v).addEventListener("click",r),f(this,v).addEventListener("keydown",e=>{(e.key==="Enter"||e.key===" ")&&(e.preventDefault(),r())}),document.body.addEventListener("click",e=>{!f(this,b).contains(e.target)&&!f(this,v).contains(e.target)&&f(this,b).classList.remove("open"),f(this,b).querySelectorAll("a").forEach(o=>{o.contains(e.target)&&f(this,b).classList.remove("open")})})}};const de="modulepreload",ue=function(a){return"/starter-project-with-vite/"+a},U={},me=function(r,e,o){let t=Promise.resolve();if(e&&e.length>0){document.getElementsByTagName("link");const s=document.querySelector("meta[property=csp-nonce]"),i=(s==null?void 0:s.nonce)||(s==null?void 0:s.getAttribute("nonce"));t=Promise.allSettled(e.map(c=>{if(c=ue(c),c in U)return;U[c]=!0;const u=c.endsWith(".css"),p=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${p}`))return;const m=document.createElement("link");if(m.rel=u?"stylesheet":de,u||(m.as="script"),m.crossOrigin="",m.href=c,i&&m.setAttribute("nonce",i),document.head.appendChild(m),u)return new Promise((n,d)=>{m.addEventListener("load",n),m.addEventListener("error",()=>d(new Error(`Unable to preload CSS for ${c}`)))})}))}function l(s){const i=new Event("vite:preloadError",{cancelable:!0});if(i.payload=s,window.dispatchEvent(i),!i.defaultPrevented)throw s}return t.then(s=>{for(const i of s||[])i.status==="rejected"&&l(i.reason);return r().catch(l)})};function pe(a={}){const{immediate:r=!1,onNeedRefresh:e,onOfflineReady:o,onRegistered:t,onRegisteredSW:l,onRegisterError:s}=a;let i,c,u;const p=async(n=!0)=>{await c,u==null||u()};async function m(){if("serviceWorker"in navigator){if(i=await me(async()=>{const{Workbox:n}=await import("./workbox-window.prod.es5-B9K5rw8f.js");return{Workbox:n}},[]).then(({Workbox:n})=>new n("/starter-project-with-vite/sw.js",{scope:"/starter-project-with-vite/",type:"classic"})).catch(n=>{s==null||s(n)}),!i)return;u=()=>{i==null||i.messageSkipWaiting()};{let n=!1;const d=()=>{n=!0,i==null||i.addEventListener("controlling",h=>{h.isUpdate&&window.location.reload()}),e==null||e()};i.addEventListener("installed",h=>{typeof h.isUpdate>"u"?typeof h.isExternal<"u"&&h.isExternal?d():!n&&(o==null||o()):h.isUpdate||o==null||o()}),i.addEventListener("waiting",d)}i.register({immediate:r}).then(n=>{l?l("/starter-project-with-vite/sw.js",n):t==null||t(n)}).catch(n=>{s==null||s(n)})}}return c=m(),p}document.addEventListener("DOMContentLoaded",async()=>{pe();const a=new ce({content:document.querySelector("#main-content"),drawerButton:document.querySelector("#drawer-button"),navigationDrawer:document.querySelector("#navigation-drawer")});function r(){const n=localStorage.getItem("authToken"),d=["nav-map","nav-add","nav-profile"],h=["nav-login","nav-register"];d.forEach(g=>{const y=document.getElementById(g);y&&(y.style.display=n?"":"none")}),h.forEach(g=>{const y=document.getElementById(g);y&&(y.style.display=n?"none":"")})}function e(){const n=localStorage.getItem("authName"),d=document.getElementById("user-name"),h=document.getElementById("user-avatar"),g=document.getElementById("logout-button-header");d&&(d.textContent=n?`Hi, ${n}`:""),h&&(h.textContent=n?n[0].toUpperCase():""),g&&(g.style.display=localStorage.getItem("authToken")?"":"none"),g&&(g.onclick=()=>{localStorage.removeItem("authToken"),localStorage.removeItem("authName"),localStorage.removeItem("authUserId"),window.dispatchEvent(new Event("authchange")),window.showToast&&window.showToast("Logged out")})}function o(n,d=3500){const h=document.getElementById("toast-container");if(!h)return;const g=document.createElement("div");g.className="toast",g.textContent=n,h.appendChild(g),setTimeout(()=>{g.remove()},d)}window.showToast=o,e(),r();const t=document.getElementById("push-toggle");function l(n){const d="=".repeat((4-n.length%4)%4),h=(n+d).replace(/-/g,"+").replace(/_/g,"/"),g=atob(h),y=new Uint8Array(g.length);for(let I=0;I<g.length;++I)y[I]=g.charCodeAt(I);return y}async function s(){if(!("Notification"in window)){o("Push notifications are not supported in this browser");return}if(await Notification.requestPermission()!=="granted"){o("Notification permission denied");return}const d=await navigator.serviceWorker.ready;if(!d){o("Service Worker registration failed");return}const h=await z();if(!h){o("VAPID public key not available from API.");return}try{const g=await d.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:l(h)});localStorage.setItem("pushSubscription",JSON.stringify(g)),localStorage.setItem("pushSubscribed","1"),t&&(t.textContent="Disable Push"),o("Subscribed to push notifications");const y=localStorage.getItem("authToken");try{await Y({token:y,subscription:g})}catch{}}catch(g){console.error("subscribe error",g),o("Failed to subscribe to push: "+g.message)}}async function i(){const n=await navigator.serviceWorker.ready;if(!n)return;const d=await n.pushManager.getSubscription();if(!d){localStorage.removeItem("pushSubscription"),localStorage.removeItem("pushSubscribed"),t&&(t.textContent="Enable Push"),o("No push subscription found");return}try{await d.unsubscribe(),localStorage.removeItem("pushSubscription"),localStorage.removeItem("pushSubscribed"),t&&(t.textContent="Enable Push"),o("Push subscription removed")}catch(h){console.error("unsubscribe error",h),o("Failed to unsubscribe: "+h.message)}}if(t){const n=localStorage.getItem("pushSubscribed")==="1";t.textContent=n?"Disable Push":"Enable Push",t.onclick=async()=>{localStorage.getItem("pushSubscribed")==="1"?await i():await s()},"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(()=>{})}let c=null;const u=document.getElementById("install-button");window.addEventListener("beforeinstallprompt",n=>{n.preventDefault(),c=n,u&&(u.style.display="",u.onclick=async()=>{try{u.disabled=!0,c.prompt(),(await c.userChoice).outcome==="accepted"?window.showToast&&window.showToast("App installed"):window.showToast&&window.showToast("Install dismissed")}catch(d){console.error("Install prompt error",d)}finally{u.disabled=!1,u.style.display="none",c=null}})}),window.addEventListener("appinstalled",()=>{const n=document.getElementById("install-button");n&&(n.style.display="none")}),localStorage.getItem("authToken")||location.hash!=="#/login"&&location.hash!=="#/register"&&(location.hash="#/login"),window.addEventListener("authchange",()=>{r(),localStorage.getItem("authToken")||(location.hash="#/login"),e()});const m=document.querySelector(".skip-link");m&&m.addEventListener("click",n=>{n.preventDefault();const d=document.getElementById("main-content");d&&(d.setAttribute("tabindex","-1"),d.focus())}),await a.renderPage(),window.addEventListener("hashchange",async()=>{await a.renderPage()})});
