var $=s=>{throw TypeError(s)};var M=(s,t,e)=>t.has(s)||$("Cannot "+e);var u=(s,t,e)=>(M(s,t,"read from private field"),e?e.call(s):t.get(s)),P=(s,t,e)=>t.has(s)?$("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(s):t.set(s,e),B=(s,t,e,o)=>(M(s,t,"write to private field"),o?o.call(s,e):t.set(s,e),e),O=(s,t,e)=>(M(s,t,"access private method"),e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const c of n.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function e(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function o(r){if(r.ep)return;r.ep=!0;const n=e(r);fetch(r.href,n)}})();const A={BASE_URL:"https://story-api.dicoding.dev/v1",VAPID_PUBLIC_KEY:"BCCs2eonMI-6H2ctvFaWg-UYdDv387Vno_bzUzALpB442r2lCnsHmtrx8biyPi_E-1fSGABK_Qs_GlvPoJJqxbk",SUBSCRIBE_ENDPOINT:"/notifications/subscribe"},I=A.BASE_URL.replace(/\/$/,"");async function J({token:s=null,page:t=1,size:e=20,location:o=1}={}){const r=`${I}/stories?page=${t}&size=${e}&location=${o}`,n={};return s&&(n.Authorization=`Bearer ${s}`),await(await fetch(r,{headers:n})).json()}async function K({token:s=null,description:t="",file:e=null,lat:o=null,lon:r=null}={}){const n=!!s,c=n?`${I}/stories`:`${I}/stories/guest`,a=new FormData;a.append("description",t),e&&a.append("photo",e,e.name||"photo.jpg"),o!=null&&a.append("lat",String(o)),r!=null&&a.append("lon",String(r));const g={};return n&&(g.Authorization=`Bearer ${s}`),await(await fetch(c,{method:"POST",headers:g,body:a})).json()}async function G({name:s,email:t,password:e}={}){const o=`${I}/register`;return await(await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:s,email:t,password:e})})).json()}async function Y({email:s,password:t}={}){const e=`${I}/login`;return await(await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:s,password:t})})).json()}async function Q(){return A.VAPID_PUBLIC_KEY}async function X({token:s=null,subscription:t}={}){const e=A.SUBSCRIBE_ENDPOINT.startsWith("http")?A.SUBSCRIBE_ENDPOINT:`${I}${A.SUBSCRIBE_ENDPOINT}`,o={"Content-Type":"application/json"};s&&(o.Authorization=`Bearer ${s}`);try{const r=t.toJSON(),n={endpoint:r.endpoint,keys:r.keys};console.log("üì¶ Sending:",JSON.stringify(n,null,2));const c=await fetch(e,{method:"POST",headers:o,body:JSON.stringify(n)});if(c.status===401)return{error:!0,message:"Unauthorized. Token invalid or expired."};if(!c.ok){const a=await c.text();return console.error("‚ùå Subscribe failed:",a),{error:!0,message:`Subscribe failed: ${c.status}`}}return await c.json()}catch(r){return console.error("‚ö†Ô∏è Error:",r),{error:!0,message:r.message}}}class Z{async render(){return localStorage.getItem("authToken")?(window.location.hash="#/map","<div>Redirecting to map...</div>"):`
      <section class="auth-container">
        <div class="auth-card">
          <h1 class="auth-title">Welcome back</h1>
          <p class="auth-sub">Login to continue to the app</p>
          <form id="login-form">
            <div class="form-row">
              <label for="email">Email</label>
              <input id="email" name="email" type="email" required autocomplete="email" />
            </div>
            <div class="form-row">
              <label for="password">Password</label>
              <input id="password" name="password" type="password" required autocomplete="current-password" />
            </div>
            <div class="form-row">
              <button type="submit" class="auth-button" id="login-button">Login</button>
            </div>
            <div id="login-message" role="status" aria-live="polite" class="form-message"></div>
            <p style="text-align: center; margin-top: 16px; color: var(--gray-600);">
              Don't have an account? 
              <a href="#/register" style="color: var(--primary-600); text-decoration: none; font-weight: 500;">
                Register here
              </a>
            </p>
          </form>
        </div>
      </section>
    `}async afterRender(t){const e=t.querySelector("#login-form"),o=t.querySelector("#login-message"),r=t.querySelector("#login-button");if(!e||!o){console.error("Login form elements not found on the page!");return}if(localStorage.getItem("authToken")){window.location.hash="#/map";return}e.addEventListener("submit",async c=>{c.preventDefault(),o.textContent="",o.style.color="";const a=e.elements.email.value.trim(),g=e.elements.password.value;if(!a||!g){this.showMessage("Please fill in all fields","error",o);return}try{r.disabled=!0,r.textContent="Logging in...",r.classList.add("loading");const l=await Y({email:a,password:g});l&&l.error===!1&&l.loginResult&&l.loginResult.token?(localStorage.setItem("authToken",l.loginResult.token),l.loginResult.name&&localStorage.setItem("authName",l.loginResult.name),l.loginResult.userId&&localStorage.setItem("authUserId",l.loginResult.userId),this.showMessage("Login successful! Redirecting...","success",o),window.showToast&&window.showToast("Login successful"),window.dispatchEvent(new Event("authchange")),setTimeout(()=>{window.location.hash="#/map"},1e3)):this.showMessage(l&&l.message||"Login failed","error",o)}catch(l){console.error("Login error:",l),this.showMessage("Login error: "+l.message,"error",o)}finally{r.disabled=!1,r.textContent="Login",r.classList.remove("loading")}})}showMessage(t,e,o){o&&(o.textContent=t,o.style.color=e==="success"?"var(--success)":"var(--error)",o.className=`form-message ${e}`),window.showToast&&window.showToast(t,e)}}class ee{async render(){return localStorage.getItem("authToken")?(window.location.hash="#/map","<div>Redirecting to map...</div>"):`
      <section class="auth-container">
        <div class="auth-card">
          <h1 class="auth-title">Create account</h1>
          <p class="auth-sub">Register a new account to post stories</p>
          <form id="register-form">
            <div class="form-row">
              <label for="name">Full name</label>
              <input id="name" name="name" type="text" required autocomplete="name" />
            </div>
            <div class="form-row">
              <label for="email">Email</label>
              <input id="email" name="email" type="email" required autocomplete="email" />
            </div>
            <div class="form-row">
              <label for="password">Password</label>
              <input id="password" name="password" type="password" required minlength="8" autocomplete="new-password" />
            </div>
            <div class="form-row">
              <button type="submit" class="auth-button" id="register-button">Register</button>
            </div>
            <div id="register-message" role="status" aria-live="polite" class="form-message"></div>
            <p style="text-align: center; margin-top: 16px; color: var(--gray-600);">
              Already have an account? 
              <a href="#/login" style="color: var(--primary-600); text-decoration: none; font-weight: 500;">
                Login here
              </a>
            </p>
          </form>
        </div>
      </section>
    `}async afterRender(t){const e=t.querySelector("#register-form"),o=t.querySelector("#register-message"),r=t.querySelector("#register-button");if(!e||!o){console.error("Register form elements not found on the page!");return}if(localStorage.getItem("authToken")){window.location.hash="#/map";return}e.addEventListener("submit",async c=>{c.preventDefault(),o.textContent="",o.style.color="";const a=e.elements.name.value.trim(),g=e.elements.email.value.trim(),l=e.elements.password.value;if(!a||!g||!l){this.showMessage("Please fill in all fields","error",o);return}if(l.length<8){this.showMessage("Password must be at least 8 characters","error",o);return}try{r.disabled=!0,r.textContent="Registering...",r.classList.add("loading");const p=await G({name:a,email:g,password:l});p&&p.error===!1?(this.showMessage("Registration successful! Redirecting to login...","success",o),window.showToast&&window.showToast("Registration successful"),setTimeout(()=>{window.location.hash="#/login"},2e3)):this.showMessage(p&&p.message||"Registration failed","error",o)}catch(p){console.error("Registration error:",p),this.showMessage("Registration error: "+p.message,"error",o)}finally{r.disabled=!1,r.textContent="Register",r.classList.remove("loading")}})}showMessage(t,e,o){o&&(o.textContent=t,o.style.color=e==="success"?"var(--success)":"var(--error)",o.className=`form-message ${e}`),window.showToast&&window.showToast(t,e)}}const te="storymap-db",oe=1,k="savedStories",W="outbox";function D(){return new Promise((s,t)=>{const e=indexedDB.open(te,oe);e.onupgradeneeded=o=>{const r=o.target.result;r.objectStoreNames.contains(k)||r.createObjectStore(k,{keyPath:"id"}),r.objectStoreNames.contains(W)||r.createObjectStore(W,{autoIncrement:!0})},e.onsuccess=()=>s(e.result),e.onerror=()=>t(e.error)})}async function re(s){const t=await D();return new Promise((e,o)=>{const r=t.transaction(k,"readwrite");r.objectStore(k).put(s),r.oncomplete=()=>e(!0),r.onerror=()=>o(r.error)})}async function se(){const s=await D();return new Promise((t,e)=>{const n=s.transaction(k,"readonly").objectStore(k).getAll();n.onsuccess=()=>t(n.result||[]),n.onerror=()=>e(n.error)})}async function ne(s){const t=await D();return new Promise((e,o)=>{const r=t.transaction(k,"readwrite");r.objectStore(k).delete(s),r.oncomplete=()=>e(!0),r.onerror=()=>o(r.error)})}class q{constructor(){this._map=null,this._markers=[]}async render(){return`
      <section class="container">
        <h1>Map Page</h1>
        <div class="map-list">
          <div id="map" class="map"></div>
          <div id="story-list" class="list"></div>
        </div>
      </section>
    `}async afterRender(){const t=localStorage.getItem("authToken")||null;if(!t){const i=document.getElementById("story-list");i.innerHTML='<p>You need to <a href="#/login">login</a> to view stories on the map.</p>';return}let e;try{const i=await J({token:t,page:1,size:50,location:1});i&&i.error===!1&&Array.isArray(i.listStory)?e=i.listStory:(e=[],console.warn("Failed to fetch stories or no stories with location available",i))}catch(i){console.error("Error fetching stories",i),e=[]}if(typeof L>"u"){const i=document.getElementById("story-list");i.innerHTML="<p>Leaflet library not loaded. Check internet connection.</p>";return}const o=()=>document.getElementById("map");let r=o();const n=8;let c=0;for(;!r&&c<n;)await new Promise(i=>setTimeout(i,50)),r=o(),c+=1;if(!r){const i=document.getElementById("story-list")||document.getElementById("main-content")||document.body;i.innerHTML="<p>Map container not found in the document. Please refresh the page.</p>",console.error("Map container (#map) not found after retries. Aborting map initialization.");return}this._map=L.map(r).setView([0,0],2);const a=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}),g=L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{attribution:"&copy; CartoDB"});a.addTo(this._map);const l={OpenStreetMap:a,"Carto Light":g};L.control.layers(l).addTo(this._map);const p=document.getElementById("story-list");if(p.innerHTML="",!e.length){p.innerHTML="<p>No story with location available or failed to fetch. If the API requires authentication, please provide a token in the app (localStorage key: authToken) or login first.</p>";return}const d=[];e.forEach((i,m)=>{const f=Number(i.lat),T=Number(i.lon);if(Number.isFinite(f)&&Number.isFinite(T)){const E=L.marker([f,T]).addTo(this._map),R=`
          <div class="story-popup-content">
            <img src="${i.photoUrl}" alt="${i.name}" class="popup-photo" />
            <strong>${i.name}</strong>
            <p class="popup-date">${new Date(i.createdAt).toLocaleString()}</p>
            <p>${i.description}</p>
          </div>
        `;E.bindPopup(R),this._markers.push(E),d.push([f,T]);const h=document.createElement("button");h.className="story-item",h.type="button",h.style.display="block",h.style.textAlign="left",h.style.width="100%",h.style.padding="10px",h.style.border="0",h.style.borderBottom="1px solid var(--gray-200)",h.style.cursor="pointer",h.setAttribute("aria-label",`Open story ${i.name}`),h.innerHTML=`
          <div class="story-item-content">
            <img src="${i.photoUrl}" alt="${i.name}" class="story-item-photo" />
            <div class="story-info-wrap">
              <div class="story-name-display">${i.name}</div>
              <div class="story-date-info">${new Date(i.createdAt).toLocaleDateString()}</div>
              <div class="story-description-text">${i.description}</div>
            </div>
          </div>
        `;const U=()=>{this._markers.forEach(b=>b.closePopup()),E.openPopup(),E.setZIndexOffset(1e3),this._map.setView([f,T],12)};h.addEventListener("click",()=>{U(),h.style.background="var(--primary-100)",setTimeout(()=>h.style.background="",1e3)});const C=document.createElement("button");C.type="button",C.textContent="Save Offline",C.className="save-offline-btn primary-button",C.onclick=async()=>{try{const b={id:i.id||`${Date.now()}-${m}`,name:i.name,description:i.description,photoUrl:i.photoUrl,lat:i.lat,lon:i.lon,createdAt:i.createdAt};await re(b),window.showToast&&window.showToast("Story saved for offline")}catch(b){console.error("save offline error",b),window.showToast&&window.showToast("Failed to save story")}};const N=document.createElement("div");N.style.marginTop="8px",N.appendChild(C),h.appendChild(N),h.addEventListener("keydown",b=>{(b.key==="Enter"||b.key===" ")&&(b.preventDefault(),U(),h.focus())}),p.appendChild(h)}}),d.length>0&&this._map.fitBounds(d,{padding:[40,40]})}}class ie{constructor(){this._map=null,this._selectedLat=null,this._selectedLon=null,this._cameraStream=null,this._marker=null}async render(){return`
      <section class="container">
        <h1>Add Story</h1>
        <form id="add-story-form">
          <div>
            <label for="description">Description</label><br />
            <textarea id="description" name="description" rows="4" style="width:100%"></textarea>
          </div>
          <div style="margin-top:8px">
            <label for="photo">Photo (max 1MB)</label><br />
            <input id="photo" name="photo" type="file" accept="image/*" aria-label="Photo upload" />
            <button type="button" id="camera-button" aria-pressed="false">Use Camera</button>
            <div id="camera-preview" style="margin-top:8px"></div>
          </div>
          <div style="margin-top:8px">
            <div id="map-label" style="font-weight:600">Pick location by clicking on the map</div>
            <div id="map-add" style="height:40vh;margin-top:8px" role="application" aria-labelledby="map-label"></div>
            <div id="coords" style="margin-top:8px;color:#333" aria-live="polite">Lat: - , Lon: -</div>
          </div>
          <div style="margin-top:12px">
            <button type="submit">Submit</button>
          </div>
          <div id="form-message" style="margin-top:8px;color:green" role="status" aria-live="polite"></div>
        </form>
      </section>
    `}async afterRender(t){const e=t.querySelector("#add-story-form"),o=t.querySelector("#photo"),r=t.querySelector("#camera-button"),n=t.querySelector("#camera-preview"),c=t.querySelector("#coords"),a=t.querySelector("#form-message"),g=t.querySelector("#map-add");if(!e||!g||!r||!o){console.error("Core elements for AddStoryPage not found!");return}const l=localStorage.getItem("authToken")||null;if(!l){a.style.color="red",a.innerHTML='You need to <a href="#/login">login</a> to add a story.';return}if(typeof L>"u"){a.style.color="red",a.textContent="Leaflet library not loaded.";return}this._map=L.map(g).setView([0,0],2),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(this._map),new ResizeObserver((d,i)=>{if(this._map){const m=d[0].contentRect;m.width>0&&m.height>0&&(this._map.invalidateSize(!0),this._map.setView([0,0],2),i.disconnect())}}).observe(g),setTimeout(()=>{this._map&&this._map.invalidateSize(!0)},500),this._map.on("click",d=>{const{lat:i,lng:m}=d.latlng;this._selectedLat=i,this._selectedLon=m,c.textContent=`Lat: ${i.toFixed(6)}, Lon: ${m.toFixed(6)}`,this._marker?this._marker.setLatLng([i,m]):this._marker=L.marker([i,m]).addTo(this._map)}),r.addEventListener("click",async()=>{if(this._cameraStream){this._cameraStream.getTracks().forEach(d=>d.stop()),this._cameraStream=null,n.innerHTML="",r.textContent="Use Camera",r.setAttribute("aria-pressed","false");return}try{const d=await navigator.mediaDevices.getUserMedia({video:!0});this._cameraStream=d;const i=document.createElement("video");i.autoplay=!0,i.playsInline=!0,i.srcObject=d,i.style.maxWidth="100%",i.setAttribute("aria-label","Camera preview ‚Äî click to capture"),n.innerHTML="",n.appendChild(i),r.textContent="Stop Camera (capture will use file input)",r.setAttribute("aria-pressed","true"),i.addEventListener("click",async()=>{const m=document.createElement("canvas");m.width=i.videoWidth,m.height=i.videoHeight,m.getContext("2d").drawImage(i,0,0);const T=await new Promise(h=>m.toBlob(h,"image/jpeg",.9)),E=new DataTransfer,R=new File([T],"capture.jpg",{type:"image/jpeg"});E.items.add(R),o.files=E.files,a.style.color="green",a.textContent="Captured image from camera and set as photo input.",window.showToast&&window.showToast("Captured image from camera")})}catch(d){a.style.color="red",a.textContent="Failed to access camera: "+d.message,window.showToast&&window.showToast(a.textContent)}}),e.addEventListener("submit",async d=>{d.preventDefault(),a.style.color="green",a.textContent="";const i=e.elements.description.value.trim(),m=o.files&&o.files[0]?o.files[0]:null;if(!i){a.style.color="red",a.textContent="Description is required.";return}if(!m){a.style.color="red",a.textContent="Photo is required.";return}if(!this._selectedLat||!this._selectedLon){a.style.color="red",a.textContent="Please pick a location on the map.";return}if(m.size>1e6){a.style.color="red",a.textContent="Photo must be less than 1MB.";return}try{const f=await K({token:l,description:i,file:m,lat:this._selectedLat,lon:this._selectedLon});f&&f.error===!1?(a.style.color="green",a.textContent="Story uploaded successfully.",window.showToast&&window.showToast("Story uploaded successfully"),this._map&&this._marker&&(this._map.removeLayer(this._marker),this._marker=null,c.textContent="Lat: - , Lon: -"),e.reset(),this._cameraStream&&(this._cameraStream.getTracks().forEach(T=>T.stop()),this._cameraStream=null,n.innerHTML="")):(a.style.color="red",a.textContent=f&&f.message||"Failed to upload story.",window.showToast&&window.showToast(a.textContent))}catch(f){a.style.color="red",a.textContent="Error uploading story: "+f.message,window.showToast&&window.showToast(a.textContent)}})}}class ae{async render(){return`
      <section class="container">
        <h1>Saved Stories (Offline)</h1>
        <div id="saved-list" class="list"></div>
      </section>
    `}async afterRender(t){const e=t.querySelector("#saved-list");if(!e){console.error("Saved list element not found on page");return}e.innerHTML="<p>Loading saved stories‚Ä¶</p>";try{const o=await se();if(!o.length){e.innerHTML="<p>No saved stories yet.</p>";return}e.innerHTML="",o.forEach(r=>{const n=document.createElement("div");n.className="saved-item",n.style.padding="8px",n.style.borderBottom="1px solid #eee",n.innerHTML=`
          <div style="display:flex;gap:8px;align-items:center">
            <img src="${r.photoUrl}" alt="${r.name}" style="width:64px;height:64px;object-fit:cover;border-radius:6px;" />
            <div>
              <div style="font-weight:bold">${r.name}</div>
              <div style="font-size:0.85rem;color:#666">${new Date(r.createdAt).toLocaleString()}</div>
              <div style="margin-top:6px">${r.description}</div>
            </div>
          </div>
        `;const c=document.createElement("div");c.style.marginTop="8px";const a=document.createElement("button");a.textContent="Delete",a.onclick=async()=>{await ne(r.id),window.showToast&&window.showToast("Deleted saved story"),n.remove()},c.appendChild(a),n.appendChild(c),e.appendChild(n)})}catch(o){console.error("load saved error",o),e.innerHTML="<p>Failed to load saved stories.</p>"}}}const ce={"/":q,"/map":q,"/add":ie,"/saved":ae,"/login":Z,"/register":ee},le=()=>window.location.hash.replace("#","")||"/";var v,w,y,x,H,z;class de{constructor({navigationDrawer:t,drawerButton:e,content:o}){P(this,x);P(this,v,null);P(this,w,null);P(this,y,null);B(this,v,o),B(this,w,e),B(this,y,t),O(this,x,H).call(this)}async renderPage(){if(!u(this,v))return;const t=document.querySelector("video");t&&t.srcObject&&(t.srcObject.getTracks().forEach(r=>r.stop()),t.srcObject=null);const e=le();if(!O(this,x,z).call(this,e))return;const o=ce[e];if(!o){window.location.hash="#/";return}try{const r=new o,n=document.createElement("div");if(n.className="page",n.innerHTML=await r.render(),!!!n.querySelector("h1")){const l=window.location.hash.replace("#","")||"/",p={"/":"Map","/map":"Map","/add":"Add Story","/saved":"Saved Stories","/login":"Login","/register":"Register"},d=document.createElement("h1");d.textContent=p[l]||"Page";const i=n.querySelector("section")||n;i.insertBefore(d,i.firstChild)}const a=u(this,v).querySelector(".page"),g=(l=!1)=>l?(n.classList.add("page-enter"),u(this,v).appendChild(n),n.getBoundingClientRect(),n.classList.add("page-enter-active"),a&&(a.classList.add("page-exit"),setTimeout(()=>{a.parentElement&&a.remove()},350)),350):(a?u(this,v).replaceChild(n,a):u(this,v).appendChild(n),0);try{if(typeof document.startViewTransition=="function")await document.startViewTransition(()=>{g(!1)});else{const l=g(!0);await new Promise(p=>setTimeout(p,l))}}catch{const p=g(!0);await new Promise(d=>setTimeout(d,p))}r.afterRender&&await r.afterRender(n)}catch(r){console.error("Error creating page instance:",r),u(this,v).innerHTML=`
        <div class="container">
          <h1>Error Loading Page</h1>
          <p>There was an error loading the page. Please try again.</p>
          <button onclick="location.reload()" class="btn-primary">Reload Page</button>
        </div>
      `}}}v=new WeakMap,w=new WeakMap,y=new WeakMap,x=new WeakSet,H=function(){if(u(this,w)&&u(this,y)){u(this,w).setAttribute("aria-controls",u(this,y).id||"navigation-drawer"),u(this,w).setAttribute("aria-expanded","false");const t=()=>{const e=u(this,y).classList.toggle("open");u(this,w).setAttribute("aria-expanded",String(e))};u(this,w).addEventListener("click",t),u(this,w).addEventListener("keydown",e=>{(e.key==="Enter"||e.key===" ")&&(e.preventDefault(),t())}),document.body.addEventListener("click",e=>{!u(this,y).contains(e.target)&&!u(this,w).contains(e.target)&&u(this,y).classList.remove("open"),u(this,y).querySelectorAll("a").forEach(o=>{o.contains(e.target)&&u(this,y).classList.remove("open")})})}},z=function(t){const e=localStorage.getItem("authToken"),o=["/","/map","/add","/saved"],r=["/login","/register"];return!e&&o.includes(t)?(window.location.hash="#/login",!1):e&&r.includes(t)?(window.location.hash="#/map",!1):!0};class _{static async init(){if(!this.isSupported())return console.log("Push notifications not supported"),null;try{const t=await navigator.serviceWorker.register("/sw.js",{scope:"/",updateViaCache:"none"});if(console.log("Service Worker registered successfully:",t),await navigator.serviceWorker.ready,console.log("Service Worker is ready"),!navigator.serviceWorker.controller){console.log("Reloading page to activate Service Worker..."),window.location.reload();return}return await this.updateUI(),t}catch(t){return console.error("Service Worker registration failed:",t),null}}static isSupported(){return"serviceWorker"in navigator&&"PushManager"in window&&"Notification"in window}static async getSubscriptionStatus(){if(!this.isSupported())return{supported:!1,subscribed:!1};try{const e=await(await navigator.serviceWorker.ready).pushManager.getSubscription();return{supported:!0,subscribed:!!e,subscription:e}}catch(t){return console.error("Error getting subscription status:",t),{supported:!0,subscribed:!1,error:t.message}}}static async subscribe(){if(!this.isSupported())throw new Error("Push notifications are not supported in this browser");if(Notification.permission==="denied")throw new Error("Notification permission denied. Please enable in browser settings.");if(Notification.permission!=="granted"&&await Notification.requestPermission()!=="granted")throw new Error("Notification permission is required for push notifications");try{const t=await navigator.serviceWorker.ready;let e=await t.pushManager.getSubscription();if(e)return console.log("Already subscribed to push notifications"),await this.updateUI(),e;const o=await Q();if(!o)throw new Error("VAPID public key not available from server");e=await t.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.urlBase64ToUint8Array(o)}),localStorage.setItem("pushSubscription",JSON.stringify(e)),localStorage.setItem("pushSubscribed","1");const r=localStorage.getItem("authToken");if(r)try{await X({token:r,subscription:e}),console.log("Push subscription registered with server")}catch(n){console.warn("Failed to register subscription with server:",n)}return console.log("Successfully subscribed to push notifications"),await this.updateUI(),e}catch(t){throw console.error("Error subscribing to push notifications:",t),t}}static async unsubscribe(){if(!this.isSupported())throw new Error("Push notifications are not supported in this browser");try{const e=await(await navigator.serviceWorker.ready).pushManager.getSubscription();return e&&await e.unsubscribe()?(localStorage.removeItem("pushSubscription"),localStorage.removeItem("pushSubscribed"),console.log("Successfully unsubscribed from push notifications"),await this.updateUI(),!0):(localStorage.removeItem("pushSubscription"),localStorage.removeItem("pushSubscribed"),await this.updateUI(),!1)}catch(t){throw console.error("Error unsubscribing from push notifications:",t),t}}static async updateUI(){const t=document.getElementById("push-toggle");if(t)try{const o=(await this.getSubscriptionStatus()).subscribed;t.textContent=o?"Disable Push":"Enable Push",t.title=o?"Disable push notifications":"Enable push notifications",o?(t.style.backgroundColor="#e74c3c",t.classList.add("subscribed")):(t.style.backgroundColor="#2ecc71",t.classList.remove("subscribed"))}catch(e){console.error("Error updating push UI:",e)}}static async triggerTestNotification(){if(!navigator.serviceWorker.controller)throw new Error("Service Worker not active");const t={type:"TRIGGER_PUSH",title:"üéâ StoryMap - Test Successful!",body:"Push notifications are working perfectly! Your submission criteria should be met.",icon:"/favicon.png",url:"/#/map"};navigator.serviceWorker.controller.postMessage(t),console.log("Test notification triggered")}static urlBase64ToUint8Array(t){const e="=".repeat((4-t.length%4)%4),o=(t+e).replace(/\-/g,"+").replace(/_/g,"/"),r=window.atob(o),n=new Uint8Array(r.length);for(let c=0;c<r.length;++c)n[c]=r.charCodeAt(c);return n}}class ue{static async register(){if(!("serviceWorker"in navigator))return;let t;try{t=await navigator.serviceWorker.register("/sw.js"),console.log("SW registered: ",t),t.addEventListener("updatefound",()=>{const e=t.installing;console.log("SW update found"),e.addEventListener("statechange",()=>{e.state==="installed"&&navigator.serviceWorker.controller&&window.showToast&&window.showToast("New version available! Refresh to update.","info")})})}catch(e){console.error("SW registration failed: ",e)}t&&setInterval(()=>{t.update()},60*60*1e3)}}class j{static checkInitialAuthState(){const t=localStorage.getItem("authToken"),e=window.location.hash;console.log("Initial auth check:",{hasToken:!!t,currentHash:e||"#/"}),t?(e==="#/login"||e==="#/register"||!e||e==="#/"||e==="")&&(console.log("Redirecting to map (user is logged in)"),window.location.hash="#/map"):["#/map","#/add","#/saved","#/",""].includes(e)&&(console.log("Redirecting to login (user is not logged in)"),window.location.hash="#/login")}static handleAuthChange(){console.log("Auth change detected"),F(),V();const t=localStorage.getItem("authToken"),e=window.location.hash;t?(e==="#/login"||e==="#/register")&&(console.log("Redirecting to map after login"),window.location.hash="#/map"):e!=="#/login"&&e!=="#/register"&&(console.log("Redirecting to login after logout"),window.location.hash="#/login")}}function S(s,t="info",e=3500){const o=document.getElementById("toast-container");if(!o){console.warn("Toast container not found");return}const r=document.createElement("div");r.className=`toast toast-${t}`,r.textContent=s,o.appendChild(r),setTimeout(()=>{r.parentNode&&r.remove()},e)}function F(){const s=localStorage.getItem("authToken"),t=["nav-map","nav-add","nav-saved"],e=["nav-login","nav-register"];t.forEach(o=>{const r=document.getElementById(o);r&&(r.style.display=s?"":"none")}),e.forEach(o=>{const r=document.getElementById(o);r&&(r.style.display=s?"none":"")})}function V(){const s=localStorage.getItem("authName"),t=document.getElementById("user-name"),e=document.getElementById("user-avatar"),o=document.getElementById("logout-button-header");t&&(t.textContent=s?`Hi, ${s}`:""),e&&(e.textContent=s?s[0].toUpperCase():""),o&&(o.style.display=localStorage.getItem("authToken")?"":"none",o.onclick=()=>{localStorage.removeItem("authToken"),localStorage.removeItem("authName"),localStorage.removeItem("authUserId"),window.dispatchEvent(new Event("authchange")),S("Logged out successfully","success")})}function pe(){let s=null;const t=document.getElementById("install-button");t&&(window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),s=e,t.style.display="",t.onclick=async()=>{try{t.disabled=!0,t.textContent="Installing...",s.prompt(),(await s.userChoice).outcome==="accepted"?S("App installed successfully!","success"):S("Installation cancelled","info")}catch(o){console.error("Install prompt error",o),S("Installation failed","error")}finally{t.disabled=!1,t.textContent="Install",t.style.display="none",s=null}}}),window.addEventListener("appinstalled",()=>{const e=document.getElementById("install-button");e&&(e.style.display="none")}))}document.addEventListener("DOMContentLoaded",async()=>{console.log("StoryMap App Initializing..."),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(o=>{console.log("Service Worker ready:",o),console.log("Service Worker controller:",navigator.serviceWorker.controller)}).catch(o=>{console.error("Service Worker ready failed:",o)}),await ue.register();const s=new de({content:document.querySelector("#main-content"),drawerButton:document.querySelector("#drawer-button"),navigationDrawer:document.querySelector("#navigation-drawer")});await _.init(),window.showToast=S,pe(),V(),F();const t=document.getElementById("push-toggle");t&&t.addEventListener("click",async()=>{try{(await _.getSubscriptionStatus()).subscribed?(await _.unsubscribe(),S("Push notifications disabled","success")):(await _.subscribe(),S("Push notifications enabled!","success"),setTimeout(async()=>{try{await navigator.serviceWorker.ready,await _.triggerTestNotification()}catch(n){console.error("Test notification failed:",n)}},3e3))}catch(o){console.error("Push notification error:",o),S(`Error: ${o.message}`,"error")}}),"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",o=>{console.log("Service worker message received in main thread:",o.data),o.data&&o.data.type==="NAVIGATE_TO"&&(window.location.hash=o.data.path)}),window.addEventListener("authchange",j.handleAuthChange),j.checkInitialAuthState();const e=document.querySelector(".skip-link");e&&e.addEventListener("click",o=>{o.preventDefault();const r=document.getElementById("main-content");r&&(r.setAttribute("tabindex","-1"),r.focus())});try{await s.renderPage()}catch(o){console.error("Error in initial page render:",o),S("Error loading page","error")}window.addEventListener("hashchange",async()=>{try{await s.renderPage()}catch(o){console.error("Error rendering page after hash change:",o)}}),console.log("StoryMap App Initialized Successfully")});
